<div class="cinema-index-background">
  <div class="container">
    <div class="row">
      <div class="col">

        <div class="cinema-show-card">

          <h1> <%= @cinema.name %> </h1>
          <img src="<%= @cinema.image_url %>" alt="<%= @cinema.name %>">

          <div data-controller="favourite" class="cinema-show-links">

            <div class="show-add-favourite">

              <p class="review-new-btn">
                <%= link_to "Add review", new_cinema_review_path(@cinema), class: 'review-new-btn' %>
              </p>

              <% if current_user.favourites.exists?(cinema: @cinema) %>
                <%= button_to cinema_favourite_path(@cinema, current_user.favourites.find_by(cinema: @cinema), show:true), method: :delete, data: { action: "favourite#toggle" }, class: 'favourite-toggle-form' do %>
                  <i data-favourite-target="star" class="fa-solid fa-star favourite-toggle-btn active"></i>
                <% end %>
              <% else %>
                <%= button_to cinema_favourites_path(@cinema), method: :post, remote: true, data: { action: "favourite#toggle" }, class: 'favourite-toggle-form' do %>
                  <i data-favourite-target="star" class="fa-regular fa-star favourite-toggle-btn"></i>
                <% end %>
              <% end %>

            </div>

            <div class="cinema-back-rating">
              <div class="show-back-btn">
                <%= link_to "Back to results", request.referer || cinemas_path %>
              </div>
              <div class="cinema-show-average">
                <p> Average rating: <%= @cinema.average_rating.present? ? @cinema.average_rating.round(1) : 'No reviews yet' %> </p>
              </div>
            </div>

          </div>

        </div>

        <div class="cinema-review-cards">
          <h2> Our community </h2>

          <% @reviews.each do |review| %>
            <div class="cinema-review">
              <%= render partial: 'cinemas/review', locals: { review: review } %>

              <%# <% if review.photos.attached? %>
                <%# <div class="review-images"> %>
                  <%# <% review.photos.each do |photo| %>
                    <%# <%= cl_image_tag photo.key, height: 100 , width: 120, crop: :fill, class: "review-image" %>
                  <%# <% end %>
                <%# </div> %>
              <%# <% end %>

              <%# add in photo uploads here (UPDATED ^) %>
              <%#= cl_image_tag @article.photo.key,  %>
              <%# add in photo uploads here %>

              <div class="review-images">
                <% if review.photos.attached? %>
                  <div class="row">
                    <%# One thumbnail for all images %>
                    <div class="col-12 col-sm-6 col-md-4 mb-3">
                      <a href="#imageModal-<%= review.id %>" data-bs-toggle="modal" data-bs-target="#imageModal-<%= review.id %>">
                        <%# First photo only as the thumbnail %>
                        <%= cl_image_tag review.photos.first.key, height: 100, width: 120, crop: :fill, class: "img-thumbnail review-image" %>
                      </a>
                    </div>

                    <!-- Modal with a carousel for all photos -->
                    <div class="modal fade" id="imageModal-<%= review.id %>" tabindex="-1" aria-labelledby="imageModalLabel-<%= review.id %>" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-body">
                            <!-- Bootstrap carousel for sliding between images -->
                            <div id="carousel-<%= review.id %>" class="carousel slide" data-bs-ride="carousel">
                              <div class="carousel-inner">
                                <% review.photos.each_with_index do |photo, index| %>
                                  <div class="carousel-item <%= 'active' if index == 0 %>">
                                    <%= cl_image_tag photo.key, class: "d-block w-100 img-fluid"  %>
                                  </div>
                                <% end %>
                              </div>

                              <%# Previous/Next carousel controls. Condition - only show if more than one image %>
                              <% if review.photos.count > 1 %>
                                <button class="carousel-control-prev" type="button" data-bs-target="#carousel-<%= review.id %>" data-bs-slide="prev">
                                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                  <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carousel-<%= review.id %>" data-bs-slide="next">
                                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                  <span class="visually-hidden">Next</span>
                                </button>
                              <% end %>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-gradient" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>


              <div class="cinema-vote-comment">
                  <div class="review-vote">
                    <div class="review-vote-arrow">
                      <% if current_user.votes.exists?(review: review) %>
                        <%= button_to cinema_review_vote_path(@cinema, review, review.votes.find_by(user: current_user)), method: :delete, class: 'vote-button' do %>
                          <i class="fa-solid fa-sort-down"></i>
                        <% end %>
                      <% else %>
                        <%= button_to cinema_review_votes_path(@cinema, review), method: :post, class: 'vote-button' do %>
                          <i class="fa-solid fa-sort-up"></i>
                        <% end %>
                      <% end %>
                    </div>
                    <div class="review-vote-count">
                      <p> <strong>(<%= review.votes.count %>)</strong> </p>
                    </div>

                  </div>
                <%# comments %>
                <div class="review-comment" data-controller="comments">
                  <div id="comments-list-<%= review.id %>">
                    <h3>
                      <button class="btn btn-link toggle-comments" data-action="click->comments#toggle" data-comments-target="toggleButton">
                        Show Comments
                      </button>
                      
                    </h3>
                    <%= turbo_stream_from "review_#{review.id}_comments" %>

                    <div id="comments-<%= review.id %>" class="comments hidden" data-comments-target="commentsSection">
                      <%= render partial: 'comments/comment', collection: review.comments, as: :comment, locals: { user: current_user } %>



                      <%= simple_form_for [@cinema, review, Comment.new],
                          html: { class: "d-flex", data: { controller: "reset-form",
                          action: "turbo:submit-end->reset-form#reset" } } do |form| %>
                        <div class="form-floating">
                          <%= form.input :content, as: :text,
                                          label: false,
                                          placeholder: "Your Comment",
                                          input_html: { rows: 3 }, wrapper: false %>
                          <label for="<%= form.object_name %>_content">Your Comment</label>
                        </div>
                          <%= form.button :submit, 'Send', class: 'btn btn-primary' %>

                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>

        </div>

      </div>
    </div>
  </div>
</div>
