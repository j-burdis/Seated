<div class="cinema-index-background">
  <div class="container">
    <div class="row">
      <div class="col">

        <div class="cinema-show-card">

          <h1> <%= @cinema.name %> </h1>
          <img src="<%= @cinema.image_url %>" alt="<%= @cinema.name %>">

          <div data-controller="favourite" class="cinema-show-links">

            <div class="show-add-favourite">

              <p class="review-new-btn">
                <%= link_to "Add review", new_cinema_review_path(@cinema), class: 'review-new-btn' %>
              </p>

              <% if current_user.favourites.exists?(cinema: @cinema) %>
                <%= button_to cinema_favourite_path(@cinema, current_user.favourites.find_by(cinema: @cinema)), method: :delete, data: { action: "favourite#toggle" }, class: 'favourite-toggle-form' do %>
                  <i data-favourite-target="star" class="fa-solid fa-star favourite-toggle-btn active"></i>
                <% end %>
              <% else %>
                <%= button_to cinema_favourites_path(@cinema), method: :post, remote: true, data: { action: "favourite#toggle" }, class: 'favourite-toggle-form' do %>
                  <i data-favourite-target="star" class="fa-regular fa-star favourite-toggle-btn"></i>
                <% end %>
              <% end %>

            </div>

            <div class="cinema-back-rating">
              <div class="show-back-btn">
                <%= link_to "Back to results", request.referer || cinemas_path %>
              </div>
              <div class="cinema-show-average">
                <p> Average rating: <%= @cinema.average_rating.present? ? @cinema.average_rating.round(1) : 'No reviews yet' %> </p>
              </div>
            </div> 

          </div>

        </div>

        <div class="cinema-review-cards">
          <h2> Our community </h2>

          <% @reviews.each do |review| %>
            <div class="cinema-review">
              <%= render partial: 'cinemas/review', locals: { review: review } %>

              <%# add in photo uploads here %>
              <%#= cl_image_tag @article.photo.key, height: 300, width: 400, crop: :fill %>
              <%# add in photo uploads here %>

              <% if review.user != current_user %>
                <div class="review-vote">
                  <div class="review-vote-arrow">
                    <% if current_user.votes.exists?(review: review) %>
                      <%= button_to 'unvote', cinema_review_vote_path(@cinema, review, review.votes.find_by(user: current_user)), 
                      method: :delete, remote: true, class: 'btn btn-danger' %>
                      <%#= link_to do %>
                          <%# <i class="fa-solid fa-sort-down"></i> %>
                      <%# end, cinema_review_vote_path(@cinema, review, review.votes.find_by(user: current_user)), method: :delete, class: 'vote-button' %>
                    <% else %>
                      <%= button_to 'upvote', cinema_review_votes_path(@cinema, review), 
                      method: :post, remote: true, class: 'btn btn-primary' %>
                      <%#= link_to do %>
                          <%# <i class="fa-solid fa-sort-up"></i> %>
                      <%# end, cinema_review_votes_path(@cinema, review), method: :post, class: 'vote-button' %>
                    <% end %>
                    <%# <i class="fa-solid fa-sort-down vote-button"></i> %>
                    <%# <i class="fa-solid fa-sort-up vote-button"></i> %>
                  </div>
                  <div class="review-vote-count">
                    <p> <strong>(<%= review.votes.count %>)</strong> </p>
                  </div>
                </div>
              <% end %>
              <%# comments %>
              <div class="review-comment">
                <div id="comments-list-<%= review.id %>">
                  <h3>Comments</h3>
                  <%= turbo_stream_from "review_#{review.id}_comments" %>
                  <%# "comments-<%= review.id %>
                  <div id="comments" class="comments">
                    <%# -<%= review.id %>
                    <%= render partial: 'comments/comment', collection: review.comments, as: :comment, locals: {user: current_user} %>
                  </div>
                </div>

                <%= simple_form_for [@cinema, review, Comment.new], 
                    html: { class: "d-flex", data: { controller: "reset-form", 
                    action: "turbo:submit-end->reset-form#reset" } } do |form| %>

                    <%= form.input :content, as: :text, 
                    label: "Your Comment", input_html: { rows: 3 }, wrapper: false %>

                    <%= form.button :submit, 'Add Comment', class: 'btn btn-primary' %>

                <% end %>
              </div>
            </div>
          <% end %>

        </div>

      </div>
    </div>
  </div>
</div>
